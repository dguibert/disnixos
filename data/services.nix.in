let
  networkFile = @networkFile@;
  nixos = "@nixos@";

  evalConfig = import "${nixos}/lib/eval-config.nix";
  network = import networkFile;
in
{distribution, pkgs, system}:

pkgs.lib.mapAttrs (targetName: config: 
  {
    name = targetName;
    pkg = (evalConfig {
      modules = [ config ];
    }).config.system.build.toplevel;
    type = "nixos-configuration";
  }
) network
