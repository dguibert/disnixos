let
  networkFiles = [ @networkFiles@ ];
  nixos = "@nixos@";
  nixpkgs = "@nixpkgs@";
  
  pkgs = import nixpkgs {};

  evalConfig = import "${nixos}/lib/eval-config.nix";
  
  networks = map (networkFile: import networkFile) networkFiles;
  
  network = pkgs.lib.zipAttrs networks;
  
  evaluateMachines = network:
    pkgs.lib.mapAttrs (targetName: config: 
      {
        name = targetName;
        pkg = (evalConfig {
          modules = config;
          extraArgs = { nodes = evaluateMachines network; };
        }).config.system.build.toplevel;
        type = "nixos-configuration";
      }
    ) network;

in
{distribution, pkgs, system}:

evaluateMachines network
