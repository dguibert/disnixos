let
  networkFiles = [ @networkFiles@ ];
  nixpkgs = builtins.storePath @nixpkgs@;
  nixos = builtins.storePath @nixos@;
  disnixos = builtins.storePath @disnixos@;
  useBackdoor = @useBackdoor@;
  useVMTesting = @useVMTesting@;
  enableDisnix = @enableDisnix@;
  nixOpsModel = @nixOpsModel@;
  
  pkgs = import nixpkgs {};
  
  lib = import @disnixos@/share/@PACKAGE@/lib.nix {
    inherit nixpkgs nixos pkgs;
  };
  
  network = lib.generateMergedNetwork networkFiles nixOpsModel;

  configurations = lib.generateConfigurations network enableDisnix nixOpsModel useVMTesting useBackdoor;
in
pkgs.lib.mapAttrs (targetName: machine: machine.config.disnixInfrastructure.infrastructure) configurations
