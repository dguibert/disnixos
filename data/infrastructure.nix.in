let
  networkFiles = [ @networkFiles@ ];
  nixpkgs = "@nixpkgs@";
  nixos = "@nixos@";
  useBackdoor = @useBackdoor@;
  useVMTesting = @useVMTesting@;
  nixOpsModel = @nixOpsModel@;
  
  pkgs = import nixpkgs {};
  
  lib = import @datadir@/@PACKAGE@/lib.nix {
    inherit nixpkgs nixos pkgs;
  };
  
  network = lib.generateMergedNetwork networkFiles nixOpsModel;

  configurations = lib.generateConfigurations network true nixOpsModel useVMTesting useBackdoor;
in
pkgs.lib.mapAttrs (targetName: machine: machine.config.services.disnix.infrastructure) configurations
