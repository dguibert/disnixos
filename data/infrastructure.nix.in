let
  networkFiles = [ @networkFiles@ ];
  nixpkgs = "@nixpkgs@";
  nixos = "@nixos@";
  useBackdoor = @useBackdoor@;

  pkgs = import nixpkgs {};
  
  networks = map (networkFile: import networkFile) networkFiles;

  network = pkgs.lib.zipAttrs networks;

  configurations = pkgs.lib.mapAttrs (targetName: configuration: 
    (import "${nixos}/lib/eval-config.nix" {
      inherit nixpkgs;
      
      modules = configuration
      ++ [ 
        { key = "publish-infrastructure";
	  services.disnix.publishInfrastructure.enable = true;
	  services.disnix.publishInfrastructure.enableAuthentication = true;
	  networking.hostName = targetName;
	}
      ]
      ++ pkgs.lib.optional useBackdoor {
        key = "backdoor";
	services.disnix.infrastructure.backdoor = "TCP:${targetName}:512";
      };
      extraArgs = configurations;
    }).config) network;
in
pkgs.lib.mapAttrs (targetName: config: config.services.disnix.infrastructure) configurations
