#!/bin/bash
set -e
set -o pipefail

# DisnixOS - Infrastructure deployment extension for Disnix
# Copyright (C) 2008-2015  Sander van der Burg
#
# This library is free software; you can redistribute it and/or
# modify it under the terms of the GNU Lesser General Public
# License as published by the Free Software Foundation; either
# version 2.1 of the License, or (at your option) any later version.
#
# This library is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
# Lesser General Public License for more details.
#
# You should have received a copy of the GNU Lesser General Public
# License along with this library; if not, write to the Free Software
# Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301  USA

# Shows the usage of this command to the user

showUsage()
{
    cat <<EOF
Usage: $0 -s services_nix -n network.nix [ -n network2.nix ... ] -d distribution_nix [OPTION]

The command \`disnixos-env' is used to install or upgrade the services and
infrastructure of distributed system in a given environment. This command
requires three Nix expressions as input parameters; A services model capturing
the components of a distributed system and its inter-dependencies; A network
model capturing the NixOS configurations of machines in the network and its
properties and a distribution model which maps services to machines.

By invoking this command it will first build, distribute and activate all the
NixOS configurations of the machines in the network. Then it will build all the
services that are defined in the distribution model from source code including
all its dependencies. If all the services are successfully built, the closures
of the services are transferred to the target machines in the network. Finally,
the services are activated by traversing the inter-dependency graph of all the
services. In case of a failure, a rollback is performed to bring the system back
in its previous configuration.

When there is already a distributed system configuration deployed, an upgrade is
performed. In this phase only the changed parts of the system are deactivated and
activated. In this process we also deal with the inter-dependencies so that no
service deployment fails due to a missing inter-dependency.

This command is essentially a composition of the \`disnixos-deploy-network'
command (which deploys the infrastructure) and \`disnix-env' (which deploys the
services of which the system is composed).

Optionally this command can use \`nixops' instead of \`disnixos-deploy-network',
by adding the --use-nixops command-line option or by setting DISNIXOS_USE_NIXOPS
environment variable.

Options:
  -s, --services=services_nix
                                  Services Nix expression which describes all
                                  components of the distributed system
  -n, --network=network_nix       Network Nix expression which declares a NixOS
                                  configuration for each machine in the network
  -d, --distribution=distribution_nix
                                  Distribution Nix expression which maps
                                  services to machines in the network
      --target-property=PROP      The target property of an infrastructure
                                  model, that specifies how to
      --deploy-state              Indicates whether to globally deploy state
                                  (disabled by default)
  -p, --profile=PROFILE           Name of the profile that is used for this
                                  system. Defaults to: default
  -m, --max-concurrent-transfers=NUM
                                  Maximum amount of concurrent closure
                                  transfers. Defauls to: 2
      --build-on-targets          Build the services on the target machines in
                                  the network instead of managing the build by
                                  the coordinator
      --coordinator-profile-path=PATH
                                  Path where to store the coordinator profile
                                  generations
      --no-upgrade                Do not perform an upgrade, but activate all
                                  services of the new configuration
      --no-lock                   Do not attempt to acquire and release any
                                  locks
      --no-coordinator-profile    Specifies that the coordinator profile should
                                  not be updated
      --no-target-profiles        Specifies that the target profiles should not
                                  be updated
      --no-delete-state           Do not remove the state of deactivated services
      --show-trace                Shows a trace of the output
      --use-nixops                Use NixOps instead of Disnix's deployment
                                  facilities
      --disable-disnix            Do not enable the Disnix service on the target
                                  machines by default
      --no-infra-deployment       Only deploy the services, not the
                                  infrastructure
  -h, --help                      Shows the usage of this command
  -v, --version                   Shows the version of this command

Environment:
  DISNIX_CLIENT_INTERFACE    Sets the client interface (defaults to:
                             disnix-ssh-client)
  DISNIX_TARGET_PROPERTY     Sets the target property of an infrastructure
                             model, that specifies how to connect to the remote
                             Disnix interface. (Defaults to: hostname)
  DISNIX_PROFILE             Sets the name of the profile that stores the
                             manifest on the coordinator machine and the
                             deployed services per machine on each target
                             (Defaults to: default).
  DISNIX_DEPLOY_STATE        If set to 1 it also deploys the state of all
                             components. (defaults to: 0)
  DISNIX_NO_DELETE_STATE     If set to 1 it does not delete the obsolete state
                             after upgrading. (defaults to: 0)
  DYSNOMIA_STATEDIR          Specifies where the snapshots must be stored on the
                             coordinator machine (defaults to: /var/dysnomia)
  DISNIXOS_USE_NIXOPS        When set to 1, it specifies that NixOps is used to
                             take care of the infrastructure deployment, so that
                             it properly interprets NixOps configurations and
                             uses NixOps tooling instead of Disnix's deployment
                             facilities.
EOF
}

# Shows the version of this command to the user

showVersion()
{
    cat <<EOF
$0 (@PACKAGE_NAME@ @PACKAGE_VERSION@)

Copyright (C) 2008-2015 Sander van der Burg
EOF
}

# Parse valid argument options

PARAMS=`@getopt@ -n $0 -o s:n:d:p:m:hv -l services:,network:,distribution:,profile:,max-concurrent-transfers:,target-property:,interface:,use-nixops,disable-disnix,no-infra-deployment,build-on-targets,deploy-state,no-upgrade,no-lock,no-coordinator-profile,no-target-profiles,no-delete-state,show-trace,help,version -- "$@"`

if [ $? != 0 ]
then
    showUsage
    exit 1
fi

# Evaluate valid options

eval set -- "$PARAMS"

while [ "$1" != "--" ]
do
    case "$1" in
        -s|--services)
            servicesFile=`readlink -f $2`
            ;;
        -n|--network)
            networkFiles="$networkFiles `readlink -f $2`"
            ;;
        -d|--distribution)
            distributionFile=`readlink -f $2`
            ;;
        -p|--profile)
            profileArg="--profile $2"
            ;;
        -m|--max-concurrent-transfers)
            maxConcurrentTransfersArg="-m $2"
            ;;
        --target-property)
            targetProperty=$2
            ;;
        --interface)
            interface=$2
            ;;
        --use-nixops)
            useNixOps=1
            useNixOpsArg="--use-nixops"
            ;;
        --disable-disnix)
            disableDisnixArg="--disable-disnix"
            ;;
        --no-infra-deployment)
            noInfraDeployment=1
            ;;
        --build-on-targets)
            buildOnTargetsArg="--build-on-targets"
            ;;
        --deploy-state)
            deployStateArg="--deploy-state"
            ;;
        --no-upgrade)
            noUpgradeArg="--no-upgrade"
            ;;
        --no-lock)
            noLockArg="--no-lock"
            ;;
        --no-coordinator-profile)
            noCoordinatorProfileArg="--no-coordinator-profile"
            ;;
        --no-target-profiles)
            noTargetProfilesArg="--no-target-profiles"
            ;;
        --no-delete-state)
            noDeleteStateArg="--no-delete-state"
            ;;
        --show-trace)
            showTrace=1
            ;;
        -h|--help)
            showUsage
            exit 0
            ;;
        -v|--version)
            showVersion
            exit 0
    esac
    
    shift
done

# Autoconf settings
export prefix=@prefix@

# Import checks
source @datadir@/@PACKAGE@/checks

# Import Disnix checks
source @DISNIX_PREFIX@/share/disnix/checks

# Validate the given options

checkServicesFile
checkNetworkFiles
checkDistributionFile
checkUseNixOps

# If no client interface is given and NixOps is used, then use the disnix-nixops-client by default
if [ "$useNixOps" = "1" ] && [ "$interface" = "" ] && [ "$DISNIX_CLIENT_INTERFACE" = "" ]
then
    interface=disnix-nixops-client
    locateNixOps
fi

checkClientInterface
checkTargetProperty
checkShowTrace

# Generate infrastructure model from network model
infrastructureFile=`disnixos-geninfra --no-out-link $useNixOpsArg $networkFiles`

if [ "$useNixOps" != "1" ] && [ "$noInfraDeployment" != "1" ]
then
    # Upgrade the NixOS configurations through Disnix if NixOps is not used
    disnixos-deploy-network --target-property $targetProperty --interface $interface $disableDisnixArg $profileArg $maxConcurrentTransfersArg $buildOnTargetsArg $showTraceArg $networkFiles
fi

# Upgrade the services
disnix-env -s $servicesFile -i $infrastructureFile -d $distributionFile --target-property $targetProperty --interface $interface $profileArg $maxConcurrentTransfersArg $buildOnTargetsArg $deployStateArg $noUpgradeArg $noLockArg $noCoordinatorProfileArg $noTargetProfilesArg $noDeleteStateArg $showTraceArg
